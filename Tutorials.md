# Tutorial #
This tutorial will walk you through running pyPA on PA data generated by the [CMAQ](http://www.cmaq-model.org/) air quality model.  The data used here is the test case provided by [CMAS](http://www.cmascenter.org).  If you are using other data, some steps may require modification.

## Nomenclature ##
  1. Lines that begin with `$` are intended to be run from a terminal emulator.
    * Lines that begin with `bash$` are specifically for the bash interpreter
    * Lines that begin with `csh$` are specifically for the csh or tcsh interpreters
  1. `$M3HOME` is the root directory of your CMAQ installation
  1. Lines starting with ''edit'' mean use a text editor to edit this file.

## Generate a Standard CMAQ Model Run ##
The standard model is not covered here.  You should read the documentation provided by [CMAS](http://www.cmascenter.org).  For this example, I am assuming you downloaded the CMAQ v4.7 testcase data, models, and scripts.  Further, I assume (like the CMAS tutorial) that the scripts and data folders have a shared parent folder.
```
somefolder/
  scripts/
  data/ 
```

## Generate CMAQ PA Outputs ##
### Create a Process Analysis Control Language Input ###
The simplest PACL input looks like this.

```
IRRTYPE = FULL;
IPR_OUTPUT ALL  = HADV + ZADV + HDIF + VDIF + EMIS + DDEP + CLDS +
                  CHEM + AERO;
ENDPA;
```

Replace the `$M3HOME/data/procan/pacp.inp` with the contents above.  Note that `HADV` should be replaced by `XADV + YADV + ADJC` if you are not using the new yamo advection scheme.  If the IPR output would generate too many variables (you'll know because it will tell you when you run CMAQ), you can change IPR\_OUTPUT repeat the IPR line for each species.  The benefit of this approach is that you can omit processes that each species does not undergo.

```
IPR_OUTPUT O3    = HADV + ZADV + HDIF + VDIF +        DDEP + CLDS +
                   CHEM        ;
IPR_OUTPUT HNO3  = HADV + ZADV + HDIF + VDIF +        DDEP + CLDS +
                   CHEM  + AERO;
IPR_OUTPUT NO    = HADV + ZADV + HDIF + VDIF + EMIS + DDEP + CLDS +
                   CHEM        ;
...
ENDPA;
```

### Use PROCAN to Preprocess PACL Inputs ###
  1. open a terminal emulator
  1. define `$M3HOME` as the root of your CMAQ installation (see examples below)
    * `bash$ export M3HOME=/home/username/CMAQ/v4.7`
    * `csh$ setenv M3HOME /home/username/CMAQ/v4.7`
  1. `$ cd $M3HOME/scripts/procan`
  1. ''edit'' bldit.pacp.pgf to use the right chemical mechanism
  1. `$ ./bldit.pacp.pgf`
  1. `$ ./run.pacp`

### Re-compile CMAQ with PA enabled ###
  1. `$ cd $M3HOME/scripts/cctm`
  1. ''edit'' PABase and PAOpt variables in `$M3HOME/scripts/cctm/bldit.cctm.pgf`
    1. `set PABase = $M3HOME/data/`
    1. `set PAOpt = procan`
  1. `$ ./bldit.cctm.pgf`

### Re-run CMAQ with PA outputs for the whole domain ###
  1. ''edit'' `$M3HOME/scripts/cctm/run.cctm`; add the following lines
```
setenv PA_BLEV_ELEV "1 14"
setenv PA_BROW_EROW "1 44"
setenv PA_BCOL_ECOL "1 40"
```
  1. `$ ./run.cctm`

## Post-process PA Output ##
### Install pyPA ###
[Follow installation instructions](InstallInstructions.md)

### Create a Configuration File ###
  1. `$ cd $M3HOME`
  1. `$ mkdir pyPA`
  1. `$ cd $M3HOME`
  1. `$ python -m pyPA -t -m cmaq -c cb05cl_ae5_aq > config.yaml`
  1. ''edit'' config.yaml; change the path of the input files to the full path of your CMAQ inputs/outputs
```
files: 
  - [/home/username/CMAQ/v4.7/data/cctm/CCTM_e3aPA_1.e3a, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/cctm/CCTM_e3aPA_2.e3a, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/cctm/CCTM_e3aIRR_1.e3a, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/cctm/CCTM_e3aIRR_2.e3a, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/cctm/CCTM_e3aCONC.e3a, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/mcip3/M_36_2001/METCRO3D_010722, NetCDFFile]
  - [/home/username/CMAQ/v4.7/data/mcip3/M_36_2001/METCRO2D_010722, NetCDFFile]
```

### Run pyPA ###
  1. `$ python -m pyPA config.yaml > pypa.log`
  1. review the log with a text editor. look for `Completed pyPA extract, aggregate and merge successfully!`

## Create Figures and Analysis ##
Use the [Python Environment for Reaction Mechanisms/Mathematics](http://code.google.com/p/permm) to generate physical and chemical plots and analysis.  The [permm](http://code.google.com/p/permm) site has tutorial and examples.